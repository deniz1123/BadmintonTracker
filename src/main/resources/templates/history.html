<!doctype html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>BadmintonTracker ‚Äì Historie</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f5f7fb;
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }
        .status-badge {
            font-size: 0.85rem;
            padding: 0.25rem 0.6rem;
            border-radius: 999px;
        }
        .status-laufend {
            background-color: #d1f7d6;
            color: #176b2c;
        }
        .status-beendet {
            background-color: #d7e9ff;
            color: #1957b3;
        }
        .status-abgebrochen {
            background-color: #ffe0d6;
            color: #b03619;
        }
        .team-pill {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 999px;
            border: 1px solid #ced4da;
            background-color: #f8f9fa;
            font-size: 0.85rem;
            margin-right: 0.35rem;
            margin-bottom: 0.2rem;
        }
    </style>
</head>
<body>
<div class="container my-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0">Gespeicherte Partien</h2>
            <small class="text-muted">
                √úbersicht aller gespeicherten Spiele. Von hier kommst du in die Detailansicht eines Matches.
            </small>
        </div>
        <div>
            <!-- Zur Startseite √ºber Controller, nicht index.html -->
            <a href="/" class="btn btn-outline-secondary btn-sm">
                üè† Zur Startseite
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-body">

            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <span class="fw-semibold">Anzahl Spiele:</span>
                    <span id="anzahlSpiele">0</span>
                </div>
                <small class="text-muted">
                    Tipp: Laufende Spiele sind gr√ºn markiert, beendete blau, abgebrochene orange.
                </small>
            </div>

            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                    <tr>
                        <th style="width: 60px;">ID</th>
                        <th style="width: 140px;">Datum</th>
                        <th>Teams</th>
                        <th style="width: 140px;">Ergebnis (S√§tze)</th>
                        <th style="width: 140px;">Gewinner</th>
                        <th style="width: 140px;">Status</th>
                        <th style="width: 150px;">Aktion</th>
                    </tr>
                    </thead>
                    <tbody id="spieleTableBody">
                    <!-- wird per JS gef√ºllt -->
                    </tbody>
                </table>
            </div>

            <div id="historyError" class="mt-3 text-danger small" style="display:none;">
                <!-- Fehlermeldungen -->
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        loadSpiele();
    });

    async function loadSpiele() {
        try {
            clearError();
            const resp = await fetch("/spiele");
            if (!resp.ok) {
                throw new Error("Fehler beim Laden der Spiele (Status " + resp.status + ")");
            }
            let spiele = await resp.json();

            // Sortierung: neueste zuerst (h√∂chste ID)
            spiele.sort((a, b) => (b.id ?? 0) - (a.id ?? 0));

            document.getElementById("anzahlSpiele").textContent = spiele.length;
            renderSpiele(spiele);
        } catch (err) {
            showError(err.message);
        }
    }

    function renderSpiele(spiele) {
        const tbody = document.getElementById("spieleTableBody");
        tbody.innerHTML = "";

        if (!spiele || spiele.length === 0) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 7;
            td.textContent = "Noch keine Spiele gespeichert.";
            td.classList.add("text-muted");
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
        }

        spiele.forEach(spiel => {
            const tr = document.createElement("tr");

            // ID
            const tdId = document.createElement("td");
            tdId.textContent = spiel.id ?? "-";
            tr.appendChild(tdId);

            // Datum
            const tdDatum = document.createElement("td");
            tdDatum.textContent = spiel.datum ?? "-";
            tr.appendChild(tdDatum);

            // Teams
            const tdTeams = document.createElement("td");
            renderTeamsCell(tdTeams, spiel);
            tr.appendChild(tdTeams);

            // Ergebnis (S√§tze)
            const tdErg = document.createElement("td");
            tdErg.textContent = computeSatzErgebnis(spiel);
            tr.appendChild(tdErg);

            // Gewinner
            const tdGewinner = document.createElement("td");
            tdGewinner.textContent = computeGewinnerLabel(spiel);
            tr.appendChild(tdGewinner);

            // Status
            const tdStatus = document.createElement("td");
            const statusSpan = document.createElement("span");
            statusSpan.textContent = spiel.status ?? "-";
            statusSpan.classList.add("status-badge");
            if (spiel.status === "LAUFEND") {
                statusSpan.classList.add("status-laufend");
            } else if (spiel.status === "BEENDET") {
                statusSpan.classList.add("status-beendet");
            } else if (spiel.status === "ABGEBROCHEN") {
                statusSpan.classList.add("status-abgebrochen");
            }
            tdStatus.appendChild(statusSpan);
            tr.appendChild(tdStatus);

            // Aktion
            const tdAktion = document.createElement("td");
            const btn = document.createElement("a");
            btn.className = "btn btn-primary btn-sm";
            btn.textContent = "Details ansehen";
            // auf /match/{id} gehen, damit der Controller das Template rendert
            btn.href = `/match/${encodeURIComponent(spiel.id)}`;
            tdAktion.appendChild(btn);
            tr.appendChild(tdAktion);

            tbody.appendChild(tr);
        });
    }

    function renderTeamsCell(td, spiel) {
        const teams = spiel.teams || [];
        const teamA = teams[0];
        const teamB = teams[1];

        td.innerHTML = "";

        if (teamA) {
            const spanA = document.createElement("span");
            spanA.className = "team-pill";
            spanA.textContent = "A: " + teamLabel(teamA) + " (ID " + (teamA.id ?? "-") + ")";
            td.appendChild(spanA);
        }

        if (teamB) {
            const spanB = document.createElement("span");
            spanB.className = "team-pill";
            spanB.textContent = "B: " + teamLabel(teamB) + " (ID " + (teamB.id ?? "-") + ")";
            td.appendChild(spanB);
        }

        if (!teamA && !teamB) {
            td.textContent = "-";
        }
    }

    function teamLabel(team) {
        const spieler = team.spieler || [];
        if (spieler.length === 0) return "-";
        const names = spieler.map(s =>
            `${s.vorname ?? ""} ${s.nachname ?? ""}`.trim()
        );
        return names.join(" / ");
    }

    function computeSatzErgebnis(spiel) {
        const saetze = spiel.saetze || [];
        if (saetze.length === 0) return "-";

        let aGewonnen = 0;
        let bGewonnen = 0;

        saetze.forEach(satz => {
            const a = satz.punkteTeamA ?? 0;
            const b = satz.punkteTeamB ?? 0;
            if (a > b) aGewonnen++;
            else if (b > a) bGewonnen++;
        });

        // Wenn gar kein Satz "gef√ºhrt" wurde (z.B. komplett 0:0), einfach "-"
        if (aGewonnen === 0 && bGewonnen === 0) {
            return "-";
        }
        return `${aGewonnen} : ${bGewonnen}`;
    }

    // NEU: Gewinner-Label berechnen
    function computeGewinnerLabel(spiel) {
        if (!spiel || !spiel.gewinnerTeam) {
            return "-";
        }

        const teams = spiel.teams || [];
        const teamA = teams[0];
        const teamB = teams[1];
        const winner = spiel.gewinnerTeam;

        let label = "Team ID " + (winner.id ?? "-");

        if (teamA && winner.id === teamA.id) {
            label = "Team A";
        } else if (teamB && winner.id === teamB.id) {
            label = "Team B";
        }

        if (spiel.status === "ABGEBROCHEN") {
            label += " (Sieg nach Aufgabe)";
        }

        return label;
    }

    function showError(msg) {
        const div = document.getElementById("historyError");
        div.textContent = msg;
        div.style.display = "block";
    }

    function clearError() {
        const div = document.getElementById("historyError");
        div.textContent = "";
        div.style.display = "none";
    }
</script>
</body>
</html>
